/**
 * dijit - A version of dijit.js framework that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/dijit/
 * @license MIT
 */
define(["require","dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/i18n","dojo/dom-attr","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dojo/keys","dojo/_base/lang","dojo/sniff","dojo/string","dojo/topic","./_Container","./Toolbar","./ToolbarSeparator","./layout/_LayoutWidget","./form/ToggleButton","./_editor/_Plugin","./_editor/plugins/EnterKeyHandling","./_editor/html","./_editor/range","./_editor/RichText","./_dijit","dojo/i18n!./_editor/nls/commands"],function(require,t,e,i,n,s,o,r,d,a,h,u,c,l,g,m,f,p,_,y,E,k,v,b,C){var A=e("dijit.Editor",b,{plugins:null,extraPlugins:null,constructor:function(){h.isArray(this.plugins)||(this.plugins=["undo","redo","|","cut","copy","paste","|","bold","italic","underline","strikethrough","|","insertOrderedList","insertUnorderedList","indent","outdent","|","justifyLeft","justifyRight","justifyCenter","justifyFull",E]),this._plugins=[],this._editInterval=1e3*this.editActionInterval,(u("ie")||u("trident"))&&(this.events.push("onBeforeDeactivate"),this.events.push("onBeforeActivate"))},postMixInProperties:function(){this.setValueDeferred=new i,this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._steps=this._steps.slice(0),this._undoedSteps=this._undoedSteps.slice(0),h.isArray(this.extraPlugins)&&(this.plugins=this.plugins.concat(this.extraPlugins)),this.commands=n.getLocalization("dijit._editor","commands",this.lang),u("webkit")&&d.set(this.domNode,"KhtmlUserSelect","none")},startup:function(){this.inherited(arguments),this.toolbar||(this.toolbar=new m({ownerDocument:this.ownerDocument,dir:this.dir,lang:this.lang,"aria-label":this.id}),this.header.appendChild(this.toolbar.domNode)),t.forEach(this.plugins,this.addPlugin,this),this.setValueDeferred.resolve(!0),o.add(this.iframe.parentNode,"dijitEditorIFrameContainer"),o.add(this.iframe,"dijitEditorIFrame"),s.set(this.iframe,"allowTransparency",!0),this.toolbar.startup(),this.onNormalizedDisplayChanged()},destroy:function(){t.forEach(this._plugins,function(t){t&&t.destroy&&t.destroy()}),this._plugins=[],this.toolbar.destroyRecursive(),delete this.toolbar,this.inherited(arguments)},addPlugin:function(t,e){var i=h.isString(t)?{name:t}:h.isFunction(t)?{ctor:t}:t;if(!i.setEditor){var n={args:i,plugin:null,editor:this};if(i.name&&(y.registry[i.name]?n.plugin=y.registry[i.name](i):l.publish(C._scopeName+".Editor.getPlugin",n)),!n.plugin)try{var s=i.ctor||h.getObject(i.name)||require(i.name);s&&(n.plugin=new s(i))}catch(t){throw new Error(this.id+": cannot find plugin ["+i.name+"]")}if(!n.plugin)throw new Error(this.id+": cannot find plugin ["+i.name+"]");t=n.plugin}arguments.length>1?this._plugins[e]=t:this._plugins.push(t),t.setEditor(this),h.isFunction(t.setToolbar)&&t.setToolbar(this.toolbar)},resize:function(t){t&&p.prototype.resize.apply(this,arguments)},layout:function(){var t=this._contentBox.h-(this.getHeaderHeight()+this.getFooterHeight()+r.getPadBorderExtents(this.iframe.parentNode).h+r.getMarginExtents(this.iframe.parentNode).h);this.editingArea.style.height=t+"px",this.iframe&&(this.iframe.style.height="100%"),this._layoutMode=!0},_onIEMouseDown:function(t){var e,i=this.document.body,n=i.clientWidth,s=i.clientHeight,o=i.clientLeft,r=i.offsetWidth,d=i.offsetHeight,a=i.offsetLeft;/^rtl$/i.test(i.dir||"")?n<r&&t.x>n&&t.x<r&&(e=!0):t.x<o&&t.x>a&&(e=!0),e||s<d&&t.y>s&&t.y<d&&(e=!0),e||(delete this._cursorToStart,delete this._savedSelection,"BODY"==t.target.tagName&&this.defer("placeCursorAtEnd"),this.inherited(arguments))},onBeforeActivate:function(){this._restoreSelection()},onBeforeDeactivate:function(t){this.customUndo&&this.endEditing(!0),"BODY"!=t.target.tagName&&this._saveSelection()},customUndo:!0,editActionInterval:3,beginEditing:function(t){this._inEditing||(this._inEditing=!0,this._beginEditing(t)),this.editActionInterval>0&&(this._editTimer&&this._editTimer.remove(),this._editTimer=this.defer("endEditing",this._editInterval))},_steps:[],_undoedSteps:[],execCommand:function(t){if(!this.customUndo||"undo"!=t&&"redo"!=t){this.customUndo&&(this.endEditing(),this._beginEditing());var e=this.inherited(arguments);return this.customUndo&&this._endEditing(),e}return this[t]()},_pasteImpl:function(){return this._clipboardCommand("paste")},_cutImpl:function(){return this._clipboardCommand("cut")},_copyImpl:function(){return this._clipboardCommand("copy")},_clipboardCommand:function(t){var e;try{if(e=this.document.execCommand(t,!1,null),u("webkit")&&!e)throw{code:1011}}catch(n){if(1011==n.code||9==n.code&&u("opera")){var i=c.substitute;alert(i(this.commands.systemShortcut,[this.commands[t],i(this.commands[u("mac")?"appleKey":"ctrlKey"],[{cut:"X",copy:"C",paste:"V"}[t]])]))}e=!1}return e},queryCommandEnabled:function(t){return!this.customUndo||"undo"!=t&&"redo"!=t?this.inherited(arguments):"undo"==t?this._steps.length>1:this._undoedSteps.length>0},_moveToBookmark:function(e){var i,n,s,o,r=e.mark,d=e.mark,a=e.isCollapsed;d&&(u("ie")<9||9===u("ie")&&u("quirks")?h.isArray(d)?(r=[],t.forEach(d,function(t){r.push(v.getNode(t,this.editNode))},this),this.selection.moveToBookmark({mark:r,isCollapsed:a})):d.startContainer&&d.endContainer&&(o=v.getSelection(this.window))&&o.removeAllRanges&&(o.removeAllRanges(),i=v.create(this.window),n=v.getNode(d.startContainer,this.editNode),s=v.getNode(d.endContainer,this.editNode),n&&s&&(i.setStart(n,d.startOffset),i.setEnd(s,d.endOffset),o.addRange(i))):(o=v.getSelection(this.window))&&o.removeAllRanges&&(o.removeAllRanges(),i=v.create(this.window),n=v.getNode(d.startContainer,this.editNode),s=v.getNode(d.endContainer,this.editNode),n&&s&&(i.setStart(n,d.startOffset),i.setEnd(s,d.endOffset),o.addRange(i))))},_changeToStep:function(t,e){this.setValue(e.text);var i=e.bookmark;i&&this._moveToBookmark(i)},undo:function(){var t=!1;if(!this._undoRedoActive){this._undoRedoActive=!0,this.endEditing(!0);var e=this._steps.pop();e&&this._steps.length>0&&(this.focus(),this._changeToStep(e,this._steps[this._steps.length-1]),this._undoedSteps.push(e),this.onDisplayChanged(),delete this._undoRedoActive,t=!0),delete this._undoRedoActive}return t},redo:function(){var t=!1;if(!this._undoRedoActive){this._undoRedoActive=!0,this.endEditing(!0);var e=this._undoedSteps.pop();e&&this._steps.length>0&&(this.focus(),this._changeToStep(this._steps[this._steps.length-1],e),this._steps.push(e),this.onDisplayChanged(),t=!0),delete this._undoRedoActive}return t},endEditing:function(t){this._editTimer&&(this._editTimer=this._editTimer.remove()),this._inEditing&&(this._endEditing(t),this._inEditing=!1)},_getBookmark:function(){var e=this.selection.getBookmark(),i=[];if(e&&e.mark){var n=e.mark;if(u("ie")<9||9===u("ie")&&u("quirks")){var s,o=v.getSelection(this.window);if(h.isArray(n))t.forEach(e.mark,function(t){i.push(v.getIndex(t,this.editNode).o)},this),e.mark=i;else if(o)o.rangeCount&&(s=o.getRangeAt(0)),e.mark=s?s.cloneRange():this.selection.getBookmark()}try{e.mark&&e.mark.startContainer&&(i=v.getIndex(e.mark.startContainer,this.editNode).o,e.mark={startContainer:i,startOffset:e.mark.startOffset,endContainer:e.mark.endContainer===e.mark.startContainer?i:v.getIndex(e.mark.endContainer,this.editNode).o,endOffset:e.mark.endOffset})}catch(t){e.mark=null}}return e},_beginEditing:function(){0===this._steps.length&&this._steps.push({text:k.getChildrenHtml(this.editNode),bookmark:this._getBookmark()})},_endEditing:function(){var t=k.getChildrenHtml(this.editNode);this._undoedSteps=[],this._steps.push({text:t,bookmark:this._getBookmark()})},onKeyDown:function(t){if(u("ie")||this.iframe||t.keyCode!=a.TAB||this.tabIndent||this._saveSelection(),this.customUndo){var e=t.keyCode;if(t.ctrlKey&&!t.shiftKey&&!t.altKey){if(90==e||122==e)return t.stopPropagation(),t.preventDefault(),void this.undo();if(89==e||121==e)return t.stopPropagation(),t.preventDefault(),void this.redo()}switch(this.inherited(arguments),e){case a.ENTER:case a.BACKSPACE:case a.DELETE:this.beginEditing();break;case 88:case 86:if(t.ctrlKey&&!t.altKey&&!t.metaKey){this.endEditing(),88==t.keyCode?this.beginEditing("cut"):this.beginEditing("paste"),this.defer("endEditing",1);break}default:if(!t.ctrlKey&&!t.altKey&&!t.metaKey&&(t.keyCode<a.F1||t.keyCode>a.F15)){this.beginEditing();break}case a.ALT:this.endEditing();break;case a.UP_ARROW:case a.DOWN_ARROW:case a.LEFT_ARROW:case a.RIGHT_ARROW:case a.HOME:case a.END:case a.PAGE_UP:case a.PAGE_DOWN:this.endEditing(!0);break;case a.CTRL:case a.SHIFT:case a.TAB:}}else this.inherited(arguments)},_onBlur:function(){this.inherited(arguments),this.endEditing(!0)},_saveSelection:function(){try{this._savedSelection=this._getBookmark()}catch(t){}},_restoreSelection:function(){this._savedSelection&&(delete this._cursorToStart,this.selection.isCollapsed()&&this._moveToBookmark(this._savedSelection),delete this._savedSelection)},onClick:function(){this.endEditing(!0),this.inherited(arguments)},replaceValue:function(t){this.customUndo?this.isClosed?this.setValue(t):(this.beginEditing(),t||(t="&#160;"),this.setValue(t),this.endEditing()):this.inherited(arguments)},_setDisabledAttr:function(e){this.setValueDeferred.then(h.hitch(this,function(){!this.disabled&&e||!this._buttonEnabledPlugins&&e?t.forEach(this._plugins,function(t){t.set("disabled",!0)}):this.disabled&&!e&&t.forEach(this._plugins,function(t){t.set("disabled",!1)})})),this.inherited(arguments)},_setStateClass:function(){try{this.inherited(arguments),this.document&&this.document.body&&d.set(this.document.body,"color",d.get(this.iframe,"color"))}catch(t){}}});function S(t){return new y({command:t.name})}function w(t){return new y({buttonClass:_,command:t.name})}return h.mixin(y.registry,{undo:S,redo:S,cut:S,copy:S,paste:S,insertOrderedList:S,insertUnorderedList:S,indent:S,outdent:S,justifyCenter:S,justifyFull:S,justifyLeft:S,justifyRight:S,delete:S,selectAll:S,removeFormat:S,unlink:S,insertHorizontalRule:S,bold:w,italic:w,underline:w,strikethrough:w,subscript:w,superscript:w,"|":function(){return new y({setEditor:function(t){this.editor=t,this.button=new f({ownerDocument:t.ownerDocument})}})}}),A});
//# sourceMappingURL=sourcemaps/Editor.js.map
