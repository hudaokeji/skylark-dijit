{"version":3,"sources":["selection.js"],"names":["define","array","dom","lang","has","baseWindow","focus","SelectionManager","win","doc","document","this","getType","getSelection","oSel","stype","e","rangeCount","oRange","getRangeAt","startContainer","endContainer","endOffset","startOffset","nodeType","selection","type","toLowerCase","getSelectedText","toString","createRange","text","getSelectedHtml","i","html","frag","cloneContents","div","createElement","appendChild","innerHTML","htmlText","getSelectedElement","anchorNode","childNodes","anchorOffset","range","item","getParentElement","p","parentNode","r","collapse","parentElement","node","hasAncestorElement","tagName","getAncestorElement","apply","arguments","getParentOfType","isTag","tags","_nlc","length","_tlc","String","beginning","removeAllRanges","collapseToStart","collapseToEnd","select","remove","sel","deleteFromDocument","clear","selectElementChildren","element","nochangefocus","byId","setStart","setEnd","addRange","selectAllChildren","ownerDocument","body","createTextRange","moveToElementText","selectElement","selectNode","tg","createControlRange","addElement","inSelection","newRange","compareBoundaryPoints","START_TO_END","e2","compareEndPoints","getBookmark","bm","rg","cf","curNode","isCollapsed","start","selectionStart","end","selectionEnd","pRange","mark","cloneRange","toUpperCase","len","push","console","warn","moveToBookmark","bookmark","n","isArray","forEach","window"],"mappings":"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","file":"../selection.js","sourcesContent":["define([\r\n\t\"dojo/_base/array\",\r\n\t\"dojo/dom\", // dom.byId\r\n\t\"dojo/_base/lang\",\r\n\t\"dojo/sniff\", // has(\"ie\") has(\"opera\")\r\n\t\"dojo/_base/window\",\r\n\t\"dijit/focus\"\r\n], function(array, dom, lang, has, baseWindow, focus){\r\n\r\n\t// module:\r\n\t//\t\tdijit/selection\r\n\r\n\t// Note that this class is using feature detection, but doesn't use has() because sometimes on IE the outer window\r\n\t// may be running in standards mode (ie, IE9 mode) but an iframe may be in compatibility mode.   So the code path\r\n\t// used will vary based on the window.\r\n\r\n\tvar SelectionManager = function(win){\r\n\t\t// summary:\r\n\t\t//\t\tClass for monitoring / changing the selection (typically highlighted text) in a given window\r\n\t\t// win: Window\r\n\t\t//\t\tThe window to monitor/adjust the selection on.\r\n\r\n\t\tvar doc = win.document;\r\n\r\n\t\tthis.getType = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tGet the selection type (like doc.select.type in IE).\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tvar stype = \"text\";\r\n\r\n\t\t\t\t// Check if the actual selection is a CONTROL (IMG, TABLE, HR, etc...).\r\n\t\t\t\tvar oSel;\r\n\t\t\t\ttry{\r\n\t\t\t\t\toSel = win.getSelection();\r\n\t\t\t\t}catch(e){ /*squelch*/ }\r\n\r\n\t\t\t\tif(oSel && oSel.rangeCount == 1){\r\n\t\t\t\t\tvar oRange = oSel.getRangeAt(0);\r\n\t\t\t\t\tif(\t(oRange.startContainer == oRange.endContainer) &&\r\n\t\t\t\t\t\t((oRange.endOffset - oRange.startOffset) == 1) &&\r\n\t\t\t\t\t\t(oRange.startContainer.nodeType != 3 /* text node*/)\r\n\t\t\t\t\t\t){\r\n\t\t\t\t\t\tstype = \"control\";\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn stype; //String\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\treturn doc.selection.type.toLowerCase();\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.getSelectedText = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tReturn the text (no html tags) included in the current selection or null if no text is selected\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tvar selection = win.getSelection();\r\n\t\t\t\treturn selection ? selection.toString() : \"\"; //String\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\tif(this.getType() == 'control'){\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\treturn doc.selection.createRange().text;\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.getSelectedHtml = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tReturn the html text of the current selection or null if unavailable\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tvar selection = win.getSelection();\r\n\t\t\t\tif(selection && selection.rangeCount){\r\n\t\t\t\t\tvar i;\r\n\t\t\t\t\tvar html = \"\";\r\n\t\t\t\t\tfor(i = 0; i < selection.rangeCount; i++){\r\n\t\t\t\t\t\t//Handle selections spanning ranges, such as Opera\r\n\t\t\t\t\t\tvar frag = selection.getRangeAt(i).cloneContents();\r\n\t\t\t\t\t\tvar div = doc.createElement(\"div\");\r\n\t\t\t\t\t\tdiv.appendChild(frag);\r\n\t\t\t\t\t\thtml += div.innerHTML;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn html; //String\r\n\t\t\t\t}\r\n\t\t\t\treturn null;\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\tif(this.getType() == 'control'){\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\treturn doc.selection.createRange().htmlText;\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.getSelectedElement = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tRetrieves the selected element (if any), just in the case that\r\n\t\t\t//\t\ta single element (object like and image or a table) is\r\n\t\t\t//\t\tselected.\r\n\t\t\tif(this.getType() == \"control\"){\r\n\t\t\t\tif(doc.getSelection){\r\n\t\t\t\t\t// W3C path\r\n\t\t\t\t\tvar selection = win.getSelection();\r\n\t\t\t\t\treturn selection.anchorNode.childNodes[ selection.anchorOffset ];\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// IE6-8\r\n\t\t\t\t\tvar range = doc.selection.createRange();\r\n\t\t\t\t\tif(range && range.item){\r\n\t\t\t\t\t\treturn doc.selection.createRange().item(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t};\r\n\r\n\t\tthis.getParentElement = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tGet the parent element of the current selection\r\n\t\t\tif(this.getType() == \"control\"){\r\n\t\t\t\tvar p = this.getSelectedElement();\r\n\t\t\t\tif(p){ return p.parentNode; }\r\n\t\t\t}else{\r\n\t\t\t\tif(doc.getSelection){\r\n\t\t\t\t\tvar selection = doc.getSelection();\r\n\t\t\t\t\tif(selection){\r\n\t\t\t\t\t\tvar node = selection.anchorNode;\r\n\t\t\t\t\t\twhile(node && (node.nodeType != 1)){ // not an element\r\n\t\t\t\t\t\t\tnode = node.parentNode;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn node;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tvar r = doc.selection.createRange();\r\n\t\t\t\t\tr.collapse(true);\r\n\t\t\t\t\treturn r.parentElement();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t};\r\n\r\n\t\tthis.hasAncestorElement = function(/*String*/ tagName /* ... */){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tCheck whether current selection has a  parent element which is\r\n\t\t\t//\t\tof type tagName (or one of the other specified tagName)\r\n\t\t\t// tagName: String\r\n\t\t\t//\t\tThe tag name to determine if it has an ancestor of.\r\n\t\t\treturn this.getAncestorElement.apply(this, arguments) != null; //Boolean\r\n\t\t};\r\n\r\n\t\tthis.getAncestorElement = function(/*String*/ tagName /* ... */){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tReturn the parent element of the current selection which is of\r\n\t\t\t//\t\ttype tagName (or one of the other specified tagName)\r\n\t\t\t// tagName: String\r\n\t\t\t//\t\tThe tag name to determine if it has an ancestor of.\r\n\t\t\tvar node = this.getSelectedElement() || this.getParentElement();\r\n\t\t\treturn this.getParentOfType(node, arguments); //DOMNode\r\n\t\t};\r\n\r\n\t\tthis.isTag = function(/*DomNode*/ node, /*String[]*/ tags){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tFunction to determine if a node is one of an array of tags.\r\n\t\t\t// node:\r\n\t\t\t//\t\tThe node to inspect.\r\n\t\t\t// tags:\r\n\t\t\t//\t\tAn array of tag name strings to check to see if the node matches.\r\n\t\t\tif(node && node.tagName){\r\n\t\t\t\tvar _nlc = node.tagName.toLowerCase();\r\n\t\t\t\tfor(var i=0; i<tags.length; i++){\r\n\t\t\t\t\tvar _tlc = String(tags[i]).toLowerCase();\r\n\t\t\t\t\tif(_nlc == _tlc){\r\n\t\t\t\t\t\treturn _tlc; // String\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn \"\";\r\n\t\t};\r\n\r\n\t\tthis.getParentOfType = function(/*DomNode*/ node, /*String[]*/ tags){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tFunction to locate a parent node that matches one of a set of tags\r\n\t\t\t// node:\r\n\t\t\t//\t\tThe node to inspect.\r\n\t\t\t// tags:\r\n\t\t\t//\t\tAn array of tag name strings to check to see if the node matches.\r\n\t\t\twhile(node){\r\n\t\t\t\tif(this.isTag(node, tags).length){\r\n\t\t\t\t\treturn node; // DOMNode\r\n\t\t\t\t}\r\n\t\t\t\tnode = node.parentNode;\r\n\t\t\t}\r\n\t\t\treturn null;\r\n\t\t};\r\n\r\n\t\tthis.collapse = function(/*Boolean*/ beginning){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tFunction to collapse (clear), the current selection\r\n\t\t\t// beginning: Boolean\r\n\t\t\t//\t\tIndicates whether to collapse the cursor to the beginning of the selection or end.\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tvar selection = win.getSelection();\r\n\t\t\t\tif(selection.removeAllRanges){ // Mozilla\r\n\t\t\t\t\tif(beginning){\r\n\t\t\t\t\t\tselection.collapseToStart();\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tselection.collapseToEnd();\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{ // Safari\r\n\t\t\t\t\t// pulled from WebCore/ecma/kjs_window.cpp, line 2536\r\n\t\t\t\t\tselection.collapse(beginning);\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\tvar range = doc.selection.createRange();\r\n\t\t\t\trange.collapse(beginning);\r\n\t\t\t\trange.select();\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.remove = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tFunction to delete the currently selected content from the document.\r\n\t\t\tvar sel = doc.selection;\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tsel = win.getSelection();\r\n\t\t\t\tsel.deleteFromDocument();\r\n\t\t\t\treturn sel; //Selection\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\tif(sel.type.toLowerCase() != \"none\"){\r\n\t\t\t\t\tsel.clear();\r\n\t\t\t\t}\r\n\t\t\t\treturn sel; //Selection\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.selectElementChildren = function(/*DomNode*/ element, /*Boolean?*/ nochangefocus){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tclear previous selection and select the content of the node\r\n\t\t\t//\t\t(excluding the node itself)\r\n\t\t\t// element: DOMNode\r\n\t\t\t//\t\tThe element you wish to select the children content of.\r\n\t\t\t// nochangefocus: Boolean\r\n\t\t\t//\t\tIndicates if the focus should change or not.\r\n\r\n\t\t\tvar range;\r\n\t\t\telement = dom.byId(element);\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C\r\n\t\t\t\tvar selection = win.getSelection();\r\n\t\t\t\tif(has(\"opera\")){\r\n\t\t\t\t\t//Opera's selectAllChildren doesn't seem to work right\r\n\t\t\t\t\t//against <body> nodes and possibly others ... so\r\n\t\t\t\t\t//we use the W3C range API\r\n\t\t\t\t\tif(selection.rangeCount){\r\n\t\t\t\t\t\trange = selection.getRangeAt(0);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\trange = doc.createRange();\r\n\t\t\t\t\t}\r\n\t\t\t\t\trange.setStart(element, 0);\r\n\t\t\t\t\trange.setEnd(element,(element.nodeType == 3) ? element.length : element.childNodes.length);\r\n\t\t\t\t\tselection.addRange(range);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tselection.selectAllChildren(element);\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\trange = element.ownerDocument.body.createTextRange();\r\n\t\t\t\trange.moveToElementText(element);\r\n\t\t\t\tif(!nochangefocus){\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\trange.select(); // IE throws an exception here if the widget is hidden.  See #5439\r\n\t\t\t\t\t}catch(e){ /* squelch */}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.selectElement = function(/*DomNode*/ element, /*Boolean?*/ nochangefocus){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tclear previous selection and select element (including all its children)\r\n\t\t\t// element: DOMNode\r\n\t\t\t//\t\tThe element to select.\r\n\t\t\t// nochangefocus: Boolean\r\n\t\t\t//\t\tBoolean indicating if the focus should be changed.  IE only.\r\n\t\t\tvar range;\r\n\t\t\telement = dom.byId(element);\t// TODO: remove for 2.0 or sooner, spec listed above doesn't allow for string\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C path\r\n\t\t\t\tvar selection = doc.getSelection();\r\n\t\t\t\trange = doc.createRange();\r\n\t\t\t\tif(selection.removeAllRanges){ // Mozilla\r\n\t\t\t\t\t// FIXME: does this work on Safari?\r\n\t\t\t\t\tif(has(\"opera\")){\r\n\t\t\t\t\t\t//Opera works if you use the current range on\r\n\t\t\t\t\t\t//the selection if present.\r\n\t\t\t\t\t\tif(selection.getRangeAt(0)){\r\n\t\t\t\t\t\t\trange = selection.getRangeAt(0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\trange.selectNode(element);\r\n\t\t\t\t\tselection.removeAllRanges();\r\n\t\t\t\t\tselection.addRange(range);\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\t// IE6-8\r\n\t\t\t\ttry{\r\n\t\t\t\t\tvar tg = element.tagName ? element.tagName.toLowerCase() : \"\";\r\n\t\t\t\t\tif(tg === \"img\" || tg === \"table\"){\r\n\t\t\t\t\t\trange = baseWindow.body(doc).createControlRange();\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\trange = baseWindow.body(doc).createRange();\r\n\t\t\t\t\t}\r\n\t\t\t\t\trange.addElement(element);\r\n\t\t\t\t\tif(!nochangefocus){\r\n\t\t\t\t\t\trange.select();\r\n\t\t\t\t\t}\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tthis.selectElementChildren(element, nochangefocus);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.inSelection = function(node){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tThis function determines if 'node' is\r\n\t\t\t//\t\tin the current selection.\r\n\t\t\t// tags:\r\n\t\t\t//\t\tpublic\r\n\t\t\tif(node){\r\n\t\t\t\tvar newRange;\r\n\t\t\t\tvar range;\r\n\r\n\t\t\t\tif(doc.getSelection){\r\n\t\t\t\t\t// WC3\r\n\t\t\t\t\tvar sel = win.getSelection();\r\n\t\t\t\t\tif(sel && sel.rangeCount > 0){\r\n\t\t\t\t\t\trange = sel.getRangeAt(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(range && range.compareBoundaryPoints && doc.createRange){\r\n\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\tnewRange = doc.createRange();\r\n\t\t\t\t\t\t\tnewRange.setStart(node, 0);\r\n\t\t\t\t\t\t\tif(range.compareBoundaryPoints(range.START_TO_END, newRange) === 1){\r\n\t\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}catch(e){ /* squelch */}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\t// IE6-8, so we can't use the range object as the pseudo\r\n\t\t\t\t\t// range doesn't implement the boundary checking, we have to\r\n\t\t\t\t\t// use IE specific crud.\r\n\t\t\t\t\trange = doc.selection.createRange();\r\n\t\t\t\t\ttry{\r\n\t\t\t\t\t\tnewRange = node.ownerDocument.body.createTextRange();\r\n\t\t\t\t\t\tnewRange.moveToElementText(node);\r\n\t\t\t\t\t}catch(e2){/* squelch */}\r\n\t\t\t\t\tif(range && newRange){\r\n\t\t\t\t\t\t// We can finally compare similar to W3C\r\n\t\t\t\t\t\tif(range.compareEndPoints(\"EndToStart\", newRange) === 1){\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn false; // Boolean\r\n\t\t};\r\n\r\n\t\tthis.getBookmark = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tRetrieves a bookmark that can be used with moveToBookmark to reselect the currently selected range.\r\n\r\n\t\t\t// TODO: merge additional code from Editor._getBookmark into this method\r\n\r\n\t\t\tvar bm, rg, tg, sel = doc.selection, cf = focus.curNode;\r\n\r\n\t\t\tif(doc.getSelection){\r\n\t\t\t\t// W3C Range API for selections.\r\n\t\t\t\tsel = win.getSelection();\r\n\t\t\t\tif(sel){\r\n\t\t\t\t\tif(sel.isCollapsed){\r\n\t\t\t\t\t\ttg = cf? cf.tagName : \"\";\r\n\t\t\t\t\t\tif(tg){\r\n\t\t\t\t\t\t\t// Create a fake rangelike item to restore selections.\r\n\t\t\t\t\t\t\ttg = tg.toLowerCase();\r\n\t\t\t\t\t\t\tif(tg == \"textarea\" ||\r\n\t\t\t\t\t\t\t\t(tg == \"input\" && (!cf.type || cf.type.toLowerCase() == \"text\"))){\r\n\t\t\t\t\t\t\t\tsel = {\r\n\t\t\t\t\t\t\t\t\tstart: cf.selectionStart,\r\n\t\t\t\t\t\t\t\t\tend: cf.selectionEnd,\r\n\t\t\t\t\t\t\t\t\tnode: cf,\r\n\t\t\t\t\t\t\t\t\tpRange: true\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\treturn {isCollapsed: (sel.end <= sel.start), mark: sel}; //Object.\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbm = {isCollapsed:true};\r\n\t\t\t\t\t\tif(sel.rangeCount){\r\n\t\t\t\t\t\t\tbm.mark = sel.getRangeAt(0).cloneRange();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\trg = sel.getRangeAt(0);\r\n\t\t\t\t\t\tbm = {isCollapsed: false, mark: rg.cloneRange()};\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}else if(sel){\r\n\t\t\t\t// If the current focus was a input of some sort and no selection, don't bother saving\r\n\t\t\t\t// a native bookmark.  This is because it causes issues with dialog/page selection restore.\r\n\t\t\t\t// So, we need to create pseudo bookmarks to work with.\r\n\t\t\t\ttg = cf ? cf.tagName : \"\";\r\n\t\t\t\ttg = tg.toLowerCase();\r\n\t\t\t\tif(cf && tg && (tg == \"button\" || tg == \"textarea\" || tg == \"input\")){\r\n\t\t\t\t\tif(sel.type && sel.type.toLowerCase() == \"none\"){\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tisCollapsed: true,\r\n\t\t\t\t\t\t\tmark: null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\trg = sel.createRange();\r\n\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\tisCollapsed: rg.text && rg.text.length?false:true,\r\n\t\t\t\t\t\t\tmark: {\r\n\t\t\t\t\t\t\t\trange: rg,\r\n\t\t\t\t\t\t\t\tpRange: true\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tbm = {};\r\n\r\n\t\t\t\t//'IE' way for selections.\r\n\t\t\t\ttry{\r\n\t\t\t\t\t// createRange() throws exception when dojo in iframe\r\n\t\t\t\t\t// and nothing selected, see #9632\r\n\t\t\t\t\trg = sel.createRange();\r\n\t\t\t\t\tbm.isCollapsed = !(sel.type == 'Text' ? rg.htmlText.length : rg.length);\r\n\t\t\t\t}catch(e){\r\n\t\t\t\t\tbm.isCollapsed = true;\r\n\t\t\t\t\treturn bm;\r\n\t\t\t\t}\r\n\t\t\t\tif(sel.type.toUpperCase() == 'CONTROL'){\r\n\t\t\t\t\tif(rg.length){\r\n\t\t\t\t\t\tbm.mark=[];\r\n\t\t\t\t\t\tvar i=0,len=rg.length;\r\n\t\t\t\t\t\twhile(i<len){\r\n\t\t\t\t\t\t\tbm.mark.push(rg.item(i++));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tbm.isCollapsed = true;\r\n\t\t\t\t\t\tbm.mark = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tbm.mark = rg.getBookmark();\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tconsole.warn(\"No idea how to store the current selection for this browser!\");\r\n\t\t\t}\r\n\t\t\treturn bm; // Object\r\n\t\t};\r\n\r\n\t\tthis.moveToBookmark = function(/*Object*/ bookmark){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tMoves current selection to a bookmark.\r\n\t\t\t// bookmark:\r\n\t\t\t//\t\tThis should be a returned object from getBookmark().\r\n\r\n\t\t\t// TODO: merge additional code from Editor._moveToBookmark into this method\r\n\r\n\t\t\tvar mark = bookmark.mark;\r\n\t\t\tif(mark){\r\n\t\t\t\tif(doc.getSelection){\r\n\t\t\t\t\t// W3C Range API (FF, WebKit, Opera, etc)\r\n\t\t\t\t\tvar sel = win.getSelection();\r\n\t\t\t\t\tif(sel && sel.removeAllRanges){\r\n\t\t\t\t\t\tif(mark.pRange){\r\n\t\t\t\t\t\t\tvar n = mark.node;\r\n\t\t\t\t\t\t\tn.selectionStart = mark.start;\r\n\t\t\t\t\t\t\tn.selectionEnd = mark.end;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tsel.removeAllRanges();\r\n\t\t\t\t\t\t\tsel.addRange(mark);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tconsole.warn(\"No idea how to restore selection for this browser!\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}else if(doc.selection && mark){\r\n\t\t\t\t\t//'IE' way.\r\n\t\t\t\t\tvar rg;\r\n\t\t\t\t\tif(mark.pRange){\r\n\t\t\t\t\t\trg = mark.range;\r\n\t\t\t\t\t}else if(lang.isArray(mark)){\r\n\t\t\t\t\t\trg = doc.body.createControlRange();\r\n\t\t\t\t\t\t//rg.addElement does not have call/apply method, so can not call it directly\r\n\t\t\t\t\t\t//rg is not available in \"range.addElement(item)\", so can't use that either\r\n\t\t\t\t\t\tarray.forEach(mark, function(n){\r\n\t\t\t\t\t\t\trg.addElement(n);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\trg = doc.body.createTextRange();\r\n\t\t\t\t\t\trg.moveToBookmark(mark);\r\n\t\t\t\t\t}\r\n\t\t\t\t\trg.select();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis.isCollapsed = function(){\r\n\t\t\t// summary:\r\n\t\t\t//\t\tReturns true if there is no text selected\r\n\t\t\treturn this.getBookmark().isCollapsed;\r\n\t\t};\r\n\t};\r\n\r\n\t// singleton on the main window\r\n\tvar selection = new SelectionManager(window);\r\n\r\n\t// hook for editor to use class\r\n\tselection.SelectionManager = SelectionManager;\r\n\r\n\treturn selection;\r\n});\r\n"]}